---
title: 'GBP-based Tube MPC for Multi-Robot Collision-Free Trajectory Planning'
date: 2025-10-13
permalink: /posts/2025/10/blog-post-2/
tags:
  - Gaussian Belief Propagation
  - Multi-robot planning
  - research note
---

# GBP-based Tube MPC for Multi-Robot Collision-Free Trajectory Planning

## Research Overview

본 연구는 Gaussian Belief Propagation (GBP)과 Tube MPC를 결합하여 다중 로봇 시스템의 충돌 회피 궤적 생성 문제를 해결한다. 기존 GBP 기반 방법들이 추론된 marginal Gaussian의 평균만 사용하는 것과 달리, 본 연구는 공분산 정보를 활용하여 불확실성 기반의 안전 영역(tube)을 정의하고, 그 내부에서 실시간 최적화를 수행한다.

---

## 1. Problem Statement

### 1.1 Multi-Robot System
- **N개의 로봇**: 각 로봇 $i \in \{1, ..., N\}$
- **상태**: $\mathbf{x}_i(t) \in \mathbb{R}^{n_x}$ (위치, 속도 등)
- **제어 입력**: $\mathbf{u}_i(t) \in \mathbb{R}^{n_u}$
- **동역학**: $\dot{\mathbf{x}}_i = f_i(\mathbf{x}_i, \mathbf{u}_i)$

### 1.2 Objectives
1. **충돌 회피**: $\|\mathbf{x}_i(t) - \mathbf{x}_j(t)\| > d_{safe}$ for all $i \neq j$
2. **목표 도달**: $\mathbf{x}_i(T) = \mathbf{x}_{goal,i}$
3. **동역학 제약 만족**: 입력 한계, 장애물 회피 등
4. **성능 최적화**: 에너지, 시간, 부드러움 등

### 1.3 Key Assumptions
- 로봇 간 상대 거리 측정 가능 (센서 기반)
- 통신 범위 $r_{comm}$ 내에서 메시지 교환 가능
- 통신 토폴로지는 시간에 따라 변할 수 있음

---

## 2. Proposed Framework

### 2.1 Two-Stage Architecture

```
┌─────────────────────────────────────────────────────────┐
│ Stage 1: Distributed GBP (Communication-triggered)      │
│  - 로봇 간 메시지 교환                                    │
│  - Marginal Gaussian 추론: N(μ_i, Σ_i)                  │
│  - 큰 틀의 안전 영역 정의                                 │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ Stage 2: Tube MPC (Real-time)                           │
│  - Uncertainty 기반 tube boundary 동적 조절              │
│  - Tube 내부에서 경량 MPC 수행                           │
│  - 실시간 충돌 회피 및 성능 최적화                        │
└─────────────────────────────────────────────────────────┘
```

### 2.2 Communication-triggered GBP Update

**Trigger Condition:**
로봇 $i$와 $j$ 간 거리가 통신 범위 내로 진입:
$$d_{ij}(t) = \|\mathbf{x}_i(t) - \mathbf{x}_j(t)\| \leq r_{comm}$$

**GBP Update Process:**
1. 이웃 로봇 집합 정의: $\mathcal{N}_i(t) = \{j : d_{ij}(t) \leq r_{comm}\}$
2. Factor graph 구성:
   - **Dynamics factors**: $f_{dyn,i}(\mathbf{x}_i^{t}, \mathbf{x}_i^{t+1}, \mathbf{u}_i^t)$
   - **Collision avoidance factors**: $f_{col,ij}(\mathbf{x}_i^t, \mathbf{x}_j^t)$ for $j \in \mathcal{N}_i$
   - **Goal factors**: $f_{goal,i}(\mathbf{x}_i^T)$
   - **Obstacle factors**: $f_{obs,i}(\mathbf{x}_i^t)$
3. Message passing 수행
4. Marginal 분포 추론: $p(\mathbf{x}_i^t) \approx \mathcal{N}(\boldsymbol{\mu}_i^t, \boldsymbol{\Sigma}_i^t)$

---

## 3. Tube MPC with Dynamic Boundary

### 3.1 Safety Tube Definition

각 시간 $t$에서 로봇 $i$의 안전 영역:
$$\mathcal{T}_i^t = \{\mathbf{x} : (\mathbf{x} - \boldsymbol{\mu}_i^t)^T (\boldsymbol{\Sigma}_i^t)^{-1} (\mathbf{x} - \boldsymbol{\mu}_i^t) \leq \delta_i^2(t)\}$$

여기서 $\delta_i^2(t)$는 **동적으로 조절되는 신뢰 수준**

### 3.2 Dynamic Tube Boundary Adjustment

**핵심 아이디어**: 불확실성의 크기에 따라 tube의 크기를 조절

$$\delta_i^2(t) = \delta_{base}^2 \cdot \alpha(\boldsymbol{\Sigma}_i^t, \mathcal{N}_i(t))$$

**조절 함수 $\alpha$의 설계 원칙:**
1. **높은 불확실성 영역** ($\|\boldsymbol{\Sigma}_i^t\|$ 큼):
   - $\alpha < 1$ → Tube를 작게 (보수적)
   - Mean 근처에 머물도록 강제

2. **낮은 불확실성 영역** ($\|\boldsymbol{\Sigma}_i^t\|$ 작음):
   - $\alpha \geq 1$ → Tube를 크게 (공격적)
   - 최적화 자유도 증가

3. **이웃 로봇 밀집도** ($|\mathcal{N}_i(t)|$ 큼):
   - $\alpha$ 감소 → 충돌 위험 대비 보수적

**예시 구현:**
$$\alpha(\boldsymbol{\Sigma}_i^t, \mathcal{N}_i) = \frac{\sigma_{min}}{\sigma_{min} + \text{trace}(\boldsymbol{\Sigma}_i^t)} \cdot \frac{1}{1 + \beta |\mathcal{N}_i|}$$

여기서:
- $\sigma_{min}$: 최소 불확실성 기준값
- $\beta$: 이웃 영향 가중치

### 3.3 Tube MPC Optimization

**시간 지평**: $t$ to $t + T_h$ (receding horizon)

**최적화 문제:**
$$
\begin{aligned}
\min_{\mathbf{x}_i, \mathbf{u}_i} \quad & \sum_{k=0}^{T_h} \left[ \|\mathbf{u}_i^{t+k}\|_R^2 + \|\mathbf{x}_i^{t+k} - \mathbf{x}_{ref,i}^{t+k}\|_Q^2 \right] \\
\text{s.t.} \quad & \mathbf{x}_i^{t+k+1} = f_i(\mathbf{x}_i^{t+k}, \mathbf{u}_i^{t+k}) \\
& (\mathbf{x}_i^{t+k} - \boldsymbol{\mu}_i^{t+k})^T (\boldsymbol{\Sigma}_i^{t+k})^{-1} (\mathbf{x}_i^{t+k} - \boldsymbol{\mu}_i^{t+k}) \leq \delta_i^2(t+k) \\
& \|\mathbf{x}_i^{t+k} - \mathbf{x}_j^{meas}(t+k)\| \geq d_{safe}, \quad \forall j \in \mathcal{N}_i \\
& \mathbf{u}_{min} \leq \mathbf{u}_i^{t+k} \leq \mathbf{u}_{max}
\end{aligned}
$$

**제약 조건 설명:**
1. **동역학 제약**: GBP에서 이미 고려되었지만 MPC에서 재확인
2. **Tube 내부 제약**: GBP가 보장한 큰 틀의 안전 영역
3. **실시간 충돌 회피**: 측정된 이웃 로봇 위치 기반
4. **입력 제약**: 물리적 한계

---

## 4. Algorithm

### 4.1 Overall Procedure

```
Algorithm: Distributed GBP-Tube MPC

Initialize:
  - 각 로봇의 초기 상태 x_i(0), 목표 x_goal,i
  - GBP 초기화: μ_i^t, Σ_i^t (초기 추정)

for each time step t:
  
  // Stage 1: Communication-triggered GBP Update
  for each robot i:
    이웃 탐지: N_i(t) = {j : ||x_i - x_j|| ≤ r_comm}
    
    if N_i(t) changed or t mod T_gbp == 0:
      N_i 내 로봇들과 메시지 교환
      GBP inference 수행
      Update: μ_i^{t:t+T_h}, Σ_i^{t:t+T_h}
  
  // Stage 2: Tube MPC
  for each robot i (parallel):
    동적 tube boundary 계산: δ_i^2(t:t+T_h)
    
    측정된 이웃 위치 획득: x_j^meas for j ∈ N_i
    
    Tube MPC 최적화 수행
    
    최적 제어 적용: u_i(t)
    
  상태 업데이트: x_i(t+1) = f_i(x_i(t), u_i(t))
```

### 4.2 GBP Update Frequency

**Adaptive Update Strategy:**
- **주기적 업데이트**: 매 $T_{gbp}$ 스텝마다
- **Event-triggered 업데이트**:
  - 새 로봇이 통신 범위 진입
  - 기존 이웃이 통신 범위 이탈
  - 예측 오차가 임계값 초과: $\|\mathbf{x}_i^{meas} - \boldsymbol{\mu}_i\| > \epsilon_{thresh}$

---

## 5. Key Contributions

### 5.1 Two-stage Optimization Framework
- **GBP (Global)**: 다중 로봇 조정 및 큰 틀의 충돌 회피 보장
- **Tube MPC (Local)**: 실시간 성능 최적화 및 미세 조정

### 5.2 Uncertainty-aware Tube Boundary
- 공분산 정보를 활용한 적응적 안전 마진
- 불확실성 높은 구간: 보수적 행동
- 불확실성 낮은 구간: 공격적 최적化

### 5.3 Communication-triggered Distributed GBP
- 전체 재계획 없이 국소적 조정
- 통신 오버헤드 최소화
- 확장성(scalability) 확보

### 5.4 Computational Efficiency
- GBP: 저빈도, 복잡한 제약 처리
- Tube MPC: 고빈도, 경량 최적화 (tube로 탐색 공간 제한)
- 실시간 구현 가능성

### 5.5 Safety Guarantees
- **정적 제약**: Tube 내부에서 자동 만족
- **동적 상호작용**: MPC의 실시간 충돌 회피로 보완
- 계층적 안전성 보장

---

## 6. Experimental Validation

### 6.1 Baseline Comparisons

| Method | Description |
|--------|-------------|
| **GBP-Mean** | GBP marginal의 mean만 사용 (기존 방법) |
| **Centralized MPC** | 중앙 집중식 MPC (상한선) |
| **ORCA** | Optimal Reciprocal Collision Avoidance |
| **Proposed** | GBP + Dynamic Tube MPC |

### 6.2 Evaluation Metrics

**성능 지표:**
1. **충돌 발생률**: 실행 중 안전 거리 위반 횟수
2. **목표 도달률**: 제한 시간 내 목표 도달 비율
3. **경로 효율성**: 총 이동 거리, 에너지 소비
4. **계산 시간**: GBP 업데이트 + MPC 최적화 시간
5. **통신 오버헤드**: 메시지 교환 횟수/데이터량

**안전성 지표:**
6. **안전 마진**: 최소 로봇 간 거리
7. **Tube 이탈률**: 실제 궤적이 tube를 벗어난 비율
8. **불확실성 활용도**: $\|\mathbf{x}_{actual} - \boldsymbol{\mu}\|$ 분포

### 6.3 Test Scenarios

**Scenario 1: Open Space Navigation**
- 10-20 로봇, 장애물 없음
- 무작위 시작/목표 위치
- 통신 범위 변화 영향 분석

**Scenario 2: Cluttered Environment**
- 정적 장애물 다수
- 좁은 통로 통과 상황
- Tube 동적 조절 효과 검증

**Scenario 3: Dynamic Obstacles**
- 이동하는 장애물 존재
- 실시간 재계획 능력 평가
- GBP 업데이트 빈도 최적화

**Scenario 4: Large-scale System**
- 50-100 로봇
- 확장성 및 계산 효율성 검증
- 분산 알고리즘 성능 평가

### 6.4 Ablation Studies

1. **Tube boundary 조절 전략**:
   - 고정 $\delta$ vs. 동적 $\delta(t)$
   - 다양한 $\alpha$ 함수 비교

2. **GBP 업데이트 빈도**:
   - 주기적 vs. event-triggered
   - 업데이트 빈도와 성능 trade-off

3. **통신 범위 영향**:
   - $r_{comm}$ 변화에 따른 성능 분석
   - 최적 통신 범위 도출

4. **불확실성 레벨**:
   - GBP 반복 횟수와 $\Sigma$ 크기 관계
   - 수렴도가 성능에 미치는 영향

---

## 7. Implementation Details

### 7.1 Software Stack
- **Language**: Python/C++ (성능 critical 부분)
- **Optimization**: CasADi, OSQP (convex QP), IPOPT (nonlinear)
- **Communication**: ROS2 (로봇 간 메시지 전달)
- **Simulation**: Gazebo 또는 custom 2D/3D simulator

### 7.2 Hardware Platform
- **Option 1**: 실제 로봇 (예: TurtleBot, Crazyflie 드론)
- **Option 2**: 시뮬레이션 검증 후 소규모 실험

### 7.3 Key Parameters

| Parameter | Symbol | Typical Value | Description |
|-----------|--------|---------------|-------------|
| 통신 범위 | $r_{comm}$ | 5-10 m | 메시지 교환 가능 거리 |
| 안전 거리 | $d_{safe}$ | 0.5-1.0 m | 최소 로봇 간 거리 |
| 기본 신뢰도 | $\delta_{base}^2$ | 5.99 (95%) | 카이제곱 분포 기준 |
| GBP 주기 | $T_{gbp}$ | 10-20 steps | 주기적 업데이트 간격 |
| MPC 지평 | $T_h$ | 10-20 steps | Receding horizon 길이 |
| 제어 주기 | $\Delta t$ | 0.1 s | 시간 discretization |

---

## 8. Theoretical Analysis (향후 연구)

### 8.1 Safety Guarantee
- Tube 내부 유지 조건 하에서 충돌 회피 확률 하한 도출
- GBP 수렴성과 안전성의 관계 분석

### 8.2 Computational Complexity
- GBP: $O(N \cdot K_{iter} \cdot T)$ (N: 로봇 수, K: 반복 횟수, T: 시간 지평)
- Tube MPC: $O(n_x^3 \cdot T_h)$ per robot (병렬 가능)
- 통신: $O(|\mathcal{N}_i|)$ per robot

### 8.3 Scalability
- 분산 구조로 인한 선형 확장성 ($O(N)$)
- 통신 토폴로지 희소성 활용

---

## 9. Related Work

### 9.1 GBP for Multi-Robot Planning
- [1] Distributed trajectory optimization using GBP
- [2] Factor graphs for robot coordination
- 기존 연구들은 mean만 사용 → 불확실성 정보 미활용

### 9.2 Tube MPC
- [3] Robust MPC with tube-based constraints
- [4] Chance-constrained MPC
- 주로 단일 로봇, 외란 대응용 → 다중 로봇 조정과 결합 필요

### 9.3 Distributed Multi-Robot Planning
- [5] ORCA, RVO (reactive methods)
- [6] Priority-based planning
- [7] Sequential convex programming
- 본 연구는 확률적 추론과 최적화를 통합

---

## 10. Timeline & Milestones

### Phase 1: Theory & Simulation (3개월)
- [ ] GBP factor graph 구성 및 구현
- [ ] Tube MPC 최적화 문제 정식화
- [ ] 2D 시뮬레이터 개발 (2-5 로봇)
- [ ] Baseline 방법들 구현

### Phase 2: Algorithm Development (3개월)
- [ ] 동적 tube boundary 조절 알고리즘
- [ ] Communication-triggered GBP 구현
- [ ] 분산 알고리즘 최적화
- [ ] 10-20 로봇 시뮬레이션 검증

### Phase 3: Extensive Validation (2개월)
- [ ] 다양한 시나리오 실험
- [ ] Ablation studies
- [ ] 통계적 유의성 검증
- [ ] 이론적 분석 (가능한 범위)

### Phase 4: Real-world Demo (2개월)
- [ ] ROS2 integration
- [ ] 실제 로봇 실험 (3-5대)
- [ ] 결과 분석 및 논문 작성

---

## 11. Expected Challenges & Solutions

### Challenge 1: GBP 수렴성
- **문제**: 복잡한 factor graph에서 수렴 보장 어려움
- **해결**: Damping, tree-reweighted BP, 초기값 설정 최적화

### Challenge 2: 실시간성
- **문제**: GBP + MPC 계산 부담
- **해결**: Warm-start, 병렬화, GPU 가속, 근사 기법

### Challenge 3: 통신 지연/손실
- **문제**: 무선 통신의 불안정성
- **해결**: 예측 기반 보상, 타임아웃 처리, 로버스트 메시지 프로토콜

### Challenge 4: Joint distribution 고려
- **문제**: Marginal만으로 충돌 회피 완벽히 보장 어려움
- **해결**: MPC 단계에서 실측 기반 보완, 보수적 tube 설정

---

## 12. Future Extensions

1. **3D 공간 확장**: 드론 군집에 적용
2. **이종 로봇**: 다른 동역학 모델 혼재
3. **학습 기반 tube boundary**: RL로 $\alpha$ 함수 학습
4. **장기 계획**: 계층적 플래닝과 결합
5. **형식 검증**: 안전성의 formal guarantee

---

## References

- Patwardhan, Murai, Davison, *“Distributing Collaborative Multi-Robot Planning with Gaussian Belief Propagation”*, 2022.
- Bari, Gabler, Wollherr, *“Probabilistic Inference-Based Robot Motion Planning via Gaussian Belief Propagation”*, 2023.
- Yedidia et al., *“Understanding Belief Propagation and Its Generalizations”*, 2003.

---

## Notes & Ideas

- Tube 크기를 시각화하면 로봇이 "확신하는 영역"을 직관적으로 이해 가능
- GBP 메시지는 Gaussian parameter만 전달 → 통신 효율적
- 실험에서 다양한 $\alpha$ 함수를 비교하면 좋은 ablation이 될 것
- Mean-based와 비교 시 "같은 안전성에서 더 효율적" 또는 "같은 효율성에서 더 안전"을 보이기

---

**Last Updated**: 2025-10-13