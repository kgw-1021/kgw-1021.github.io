---
title: "[연구노트] Safety MPPI : Analytical Koopman과 Safety Projection의 결합"
date: 2025-12-16 14:41:00 +0900
categories: [Control Theory, Robotics]
tags: 
  - MPPI
  - Koopman Operator
  - Safety Critical
  - Optimization
author: Geonwoo Kim
permalink: /posts/2025/12/blog-post-1/
---

<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']] 
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>

## 서론: MPPI Limitation

**Model Predictive Path Integral (MPPI)** 제어는 미분 불가능한 비용 함수나 복잡한 동역학을 가진 시스템(예: 드론, 오프로드 차량)에서 탁월한 성능을 보여줍니다. 하지만 복잡한 장애물 환경에서 MPPI를 실제로 운용해 보면 두 가지 치명적인 한계에 부딪히게 됩니다.

1.  **샘플 비효율성 (Sample Inefficiency):** 좁은 통로를 통과해야 할 때, 무작위로 뿌린 수천 개의 샘플 중 90% 이상이 벽에 부딪혀 가중치가 0이 됩니다. 즉, 계산 자원의 대부분을 '버리는 샘플'을 만드는 데 씁니다.
2.  **안전 보장의 부재 (Lack of Safety Guarantee):** 확률 기반 방식이므로, "절대 박지 않는다"는 수학적 보장을 하기가 매우 어렵습니다.

본 포스트에서는 이러한 문제를 해결하기 위해 **Analytical Koopman Operator**의 물리적 신뢰성과 **QP(Quadratic Programming) Projection**을 결합한 새로운 제어 아키텍처를 제안하고 분석합니다.

---

## 핵심 아이디어: "버리지 말고, 고쳐서 쓰자"

우리의 전략은 단순하지만 강력합니다. 벽에 부딪히는 샘플을 버리는 대신, **수학적으로 가장 가까운 안전 영역으로 '투영(Projection)'하여 유효한 샘플로 재활용**하는 것입니다.

이 과정에서 발생하는 연산 지연(Latency)과 모델 불확실성 문제는 다음 두 가지 핵심 기술로 해결합니다.

1.  **Analytical Koopman:** 딥러닝 학습 없이 물리 식에서 유도된 정확한 선형 모델 사용.
2.  **Neural Warm-Start:** QP 최적화 속도를 획기적으로 높이는 초기값 추론.

---

## 1. Analytical Koopman: 물리 기반의 선형화

보통 Koopman Operator 연구는 데이터를 모아 딥러닝으로 $A, B$ 행렬을 학습합니다(Data-driven). 하지만 안전이 중요한 제어 시스템에서 "학습 데이터가 없는 영역"에서의 예측은 신뢰할 수 없습니다.

우리는 논문 *"Real-Time Linear MPC for Quadrotors on SE(3): An Analytical Koopman-based Realization"* 에서 제안된 방식처럼, 물리 식으로부터 직접 Koopman Operator를 유도합니다.

### 상태 확장 (Observables)
비선형성을 해소하기 위해 상태 변수를 고차원 공간 $z$ 로 리프팅합니다. 예를 들어 쿼드로터의 경우 회전 행렬 $R$의 요소를 포함시킵니다.

$$
z = \psi(x) = [p, \dot{p}, R_{vec}, \omega, \dots]^T
$$

### Analytical Dynamics
이를 통해 상태 의존적인 선형 동역학을 얻을 수 있습니다.

$$
\dot{z} = \mathcal{A}(x) z + \mathcal{B}(x) u
$$

이 방식의 장점은 명확합니다.
* **No Training:** 데이터 수집 및 학습 과정 불필요.
* **High Reliability:** 물리 법칙(Newton-Euler)에 기반하므로 모델의 일반화 오차가 0에 수렴합니다.

---

## 2. Safety Projection via QP

MPPI가 생성한 샘플 $u_{sample}$이 미래에 충돌을 일으킨다면, 이를 수정해야 합니다. Koopman 덕분에 이 문제는 아주 가벼운 **선형 제약조건을 가진 QP 문제**로 바뀝니다.

$$
\begin{aligned}
\min_{\Delta u} \quad & \| \Delta u \|^2 \\
\text{s.t.} \quad & H \left( A^k z_t + \Gamma \Delta u \right) \le g
\end{aligned}
$$

* $H, g$ : 장애물을 정의하는 선형 부등식 (Polytope)
* $\Gamma$ : 입력이 미래 상태에 미치는 영향 (Convolution Matrix)

이 과정을 통해 벽을 뚫고 지나가는 멍청한 샘플이 **벽을 스치듯 지나가는 최적의 샘플**로 변환됩니다.

---

## 3. Neural Warm-Start: 실시간성의 열쇠

아무리 가벼운 QP라도, 수백 개의 샘플에 대해 매번 푸는 것은 부담입니다. 여기서 **Neural Warm-Start**가 등장합니다.

* **개념:** 아주 가벼운 MLP(Multi-Layer Perceptron)가 현재 상황을 보고 최적 입력의 수정량($\Delta u$)을 '짐작'해서 QP Solver에게 알려줍니다.
* **효과:** Solver는 바닥부터 계산하는 대신 정답 근처에서 시작하므로, 반복 횟수(Iteration)가 획기적으로 줄어듭니다.

> "Neural Net은 '감'을 잡고, QP Solver는 '검증'을 합니다."

---

## 전체 시스템 아키텍처

제안하는 시스템의 데이터 흐름은 다음과 같습니다.

<div style="text-align: center; margin: 20px 0;">
  <img src="/images/post/2025-12-16-blog-post-1/mppi_diagram.png" alt="Analytical Koopman MPPI Architecture" width="50%" style="border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
  <br>
  <em style="color: gray; font-size: 0.9em;">Figure 1. Analytical Koopman 기반의 Safe MPPI 프로세스 다이어그램</em>
</div>


**Last Updated**: 2025-12-16