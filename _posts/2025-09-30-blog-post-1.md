---
title: 'MPC controller Implementation 1, Cart Pole'
date: 2025-09-30
permalink: /posts/2025/09/blog-post-1/
tags:
  - control
  - optimization control
  - mpc
  - cart pole
  - OSQP
---

<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']] 
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>

# CartPole 환경에서 MPC Controller 구현

## Theory: MPC Formulation as a Quadratic Programming Problem

MPC(Model Predictive Control)는 유한한 시간 구간 $T$동안의 최적 제어 문제(OCP, Optimal Control Problem)로 정의된다.  
이 문제는 일반적으로 다음과 같은 형태로 표현된다.

$$
\min_{u_{0:T-1}} \sum_{t=0}^{T-1} \left( x_t^\top Q x_t + u_t^\top R u_t \right) + x_T^\top Q_f x_T
$$

subject to

$$
x_{t+1} = f(x_t, u_t), \quad \forall t \in [0, T-1]
$$

여기서  
- $x_t$ : 상태 벡터 (cart 위치, 속도, pole 각도, 각속도 포함)  
- $u_t$ : 제어 입력 (cart에 가해지는 힘)  
- $Q, R$ : 상태 및 입력 가중 행렬  
- $Q_f$ : Terminal 상태 가중 행렬

---

###  - Nonlinear Dynamics as Constraints

Cart-Pole 시스템은 비선형 동역학을 가지며, 이는 equality constraint로 모델링된다.

$$
x_{t+1} = f(x_t, u_t)
$$

이 때, $f(\cdot)$는 물리 기반의 비선형 시스템으로 구성되어 있어, 직접적인 해석이 어렵다.  
따라서, **비선형 제약 조건을 선형 근사(linearization)** 하여 **QP 문제(Quadratic Programming)** 형태로 변환한다.

---

###  - Quadratic Programming Formulation

근사화된 선형 시스템을 이용하면, 다음과 같은 QP 형태로 MPC 문제를 정의할 수 있다.

$$
\min_{z} \frac{1}{2} z^\top H z + f^\top z
$$

subject to

$$
A_{eq} z = b_{eq}, \quad A_{ineq} z \le b_{ineq}
$$

여기서  
- $z = [x_0, u_0, x_1, u_1, \dots, x_T]^\top$ : 상태와 제어 입력을 포함하는 결정 변수 벡터  
- $H$ : 비용 함수의 Hessian 행렬 (주로 $Q, R$ 로 구성)  
- $A_{eq}, b_{eq}$ : 시스템 동역학으로부터 유도된 equality constraint  
- $A_{ineq}, b_{ineq}$ : 입력 제한 등 inequality constraint  

이렇게 QP 형태로 정의된 문제는 다양한 QP solver (OSQP 등)를 통해 빠르게 해결할 수 있으며,  
각 스텝에서 첫 번째 제어 입력만 실제로 시스템에 적용하고,  
이후 horizon을 이동시키는 **Receding Horizon Control (RHC)** 방식으로 동작한다.

---

### - Implementation Note

- **Symbolic Optimization Framework**: CasADi를 이용해 문제를 정의  
- **Solver**: OSQP (작고 빠른 문제에 적합)  
- **특징**: Time-invariant 문제로 설정 후, 현재 상태만 갱신하며 실시간 제어 수행 가능  

---

이와 같이 MPC 문제를 QP 형태로 정리함으로써,  
Cart-Pole 시스템에서 안정적인 제어를 효율적으로 수행할 수 있다.
