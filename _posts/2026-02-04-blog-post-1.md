---
title: 'Projection-Guided MPPI'
date: 2026-02-04
permalink: /posts/2026/02/blog-post-2/
tags:
  - control 
  - MPPI
  - planning
  - EKI
  - Guided MPPI
  - ADMM
---

<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']] 
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>

# Projection-Guided MPPI: Feasibility Biasing for Sampling-Based Control

## 1. Motivation

Model Predictive Path Integral (MPPI) control is a sampling-based MPC framework
that naturally handles nonlinear dynamics without requiring gradients or Jacobians.
Despite its flexibility, vanilla MPPI exhibits a fundamental limitation:

> **Sampling is agnostic to feasibility.**

In constrained environments (e.g., obstacle avoidance, state limits, actuator bounds),
a significant portion of sampled trajectories violate constraints early,
resulting in wasted computation and noisy policy updates.

This note explores a simple idea:

> **Instead of enforcing constraints exactly,  
we bias the sampling process so that feasible trajectories dominate naturally.**

---

## 2. MPPI Recap

MPPI samples control perturbations around a nominal control sequence:

$$
u_t^{(i)} = \bar{u}_t + \epsilon_t^{(i)}, 
\quad \epsilon_t^{(i)} \sim \mathcal{N}(0, \Sigma)
$$

Each sample is rolled out through nonlinear dynamics:

$$
x_{t+1}^{(i)} = f\left(x_t^{(i)}, u_t^{(i)}\right)
$$

The nominal control is updated via a cost-weighted average:

$$
\bar{u}_t^{+} = \sum_{i=1}^{N} w^{(i)} u_t^{(i)},
\quad
w^{(i)} = \frac{\exp\left(-\frac{1}{\lambda} J^{(i)}\right)}
{\sum_j \exp\left(-\frac{1}{\lambda} J^{(j)}\right)}
$$

Implicitly, MPPI approximates the optimal control distribution
with a single Gaussian by minimizing a KL divergence.

---

## 3. Problem: Sampling Without Structure

In constrained problems, vanilla MPPI suffers from:

1. **Low effective sample efficiency**  
   Most samples are infeasible and discarded by cost.

2. **Delayed mode discrimination**  
   Feasible and infeasible behaviors are only separated after rollout.

This motivates injecting *structural information* **before** cost evaluation.

---

## 4. Projection-Guided MPPI: Algorithm Overview

We introduce an intermediate **projection step** between sampling and rollout:

> **__Sampling → Projection → Rollout → Cost Evaluation → Policy Update__**

Key principles:

- Projection is **not** a constraint solver.
- Constraints are **not enforced exactly**.
- Projection only provides a **feasibility bias**.
- The final decision is always made by **cost evaluation**.

---

## 5. Projection as Feasibility Biasing

Let \( \{u^{(i)}\}_{i=1}^{N} \) denote sampled control sequences.
We apply a single projection step:

$$
\tilde{u}^{(i)} = \mathcal{P}\left(u^{(i)}\right)
$$

where \( \mathcal{P}(\cdot) \) consists of:

- **Geometric projections**  
  (e.g., obstacle avoidance, bound clipping)

- **Dynamics-aware shaping**  
  using Ensemble Kalman Inversion (EKI)

Crucially:

- Projection is **single-shot**
- No inner-loop convergence is attempted
- Exploration noise is re-injected at the next MPPI iteration

---

## 6. Dynamics-Aware Projection via Ensemble Kalman Inversion

EKI is used to bias samples toward dynamically consistent regions
without requiring explicit Jacobians.

Constraint residuals are interpreted as noisy observations:

$$
y = 0 + \eta
$$

Given an ensemble \( \{u^{(i)}\} \), EKI performs the update:

$$
u^{(i)} \leftarrow u^{(i)} + K \left(y - \hat{y}^{(i)}\right)
$$

where the Kalman gain is estimated from ensemble statistics:

$$
K = C_{u y} \left(C_{y y} + R\right)^{-1}
$$

Here:

-  $C_{u y}$ is the cross-covariance between control samples and residuals
-  $C_{y y}$  is the residual covariance
-  $R$ is an artificial noise covariance controlling update strength

Important properties:

- Jacobian-free
- Naturally handles nonlinear dynamics
- Updates the **distribution**, not a single trajectory

EKI is **not** used to enforce constraints,
but to suppress directions that systematically violate dynamics.

---

## 7. Mode Selection Through Sampling and Cost

Feasibility does not need to be enforced explicitly.

- **Feasible modes**  
  - survive projection  
  - produce stable rollouts  
  - receive low cost  

- **Infeasible modes**  
  - diverge during rollout  
  - accumulate high cost  
  - vanish through MPPI weighting  

Thus, mode selection emerges naturally from:

$$
\text{Sampling} + \text{Feasibility Bias} + \text{Cost-Based Selection}
$$

---

## 8. Stability Considerations

Projection must remain **weak**.

Failure cases arise when:

- projection is iterated until convergence
- ensemble variance collapses prematurely
- exploration noise is not re-injected

Safe design rules:

1. One projection step per MPPI iteration
2. Covariance floor in EKI
3. Cost evaluation as the final arbiter

---

## 9. Interpretation

Projection-Guided MPPI can be interpreted as:

> **Feasibility-guided sampling-based MPC**

Constraints are treated as statistical biases,
not hard requirements.

The method trades exact feasibility for robustness and computational efficiency,
making it well-suited for real-time nonlinear control.

---

## 10. Summary

- Projection-Guided MPPI injects structural feasibility information into sampling.
- Constraints bias the distribution rather than defining a feasible set.
- Dynamics are incorporated via Jacobian-free ensemble updates.
- Final decisions are always made by cost evaluation.

This framework aligns naturally with receding-horizon control
and highly nonlinear systems where exact constraint enforcement is impractical.
